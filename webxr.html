<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>AR.js with GLTF Model</title>
    <meta name="viewport" content="width=device-width, user-scalable=yes, minimum-scale=1.0, maximum-scale=1.0">
    <!-- include aframe -->
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <!-- include ar.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- include aframe loaders -->
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v7.0.0/dist/aframe-extras.loaders.min.js"></script>
    <script>
        AFRAME.registerComponent("foo", {
            init: function () {
                this.el.addEventListener("model-loaded", e => {
                    let model = this.el.getObject3D("mesh");
                    model.traverse(function (node) {
                        if (!node.material) return;
                        var tmp = node.material;
                        node.material = new THREE.MeshStandardMaterial({
                            skinning: true,
                            map: node.material.map
                        });
                        node.material.needsUpdate = true;
                        tmp.dispose();
                    });
                });
            }
        });
    </script>

</head>

<body style='margin : 0px; overflow: hidden;'>

    <a-scene vr-mode-ui="enabled: false" renderer="antialias: false; logarithmicDepthBuffer:true" embedded arjs>
        <a-entity light="type: ambient; intensity: 2.2"></a-entity>

        <!-- Add a camera -->
        <a-entity camera>
            <a-entity id="raycasterCursor" cursor="rayOrigin: mouse; fuse: false" raycaster="objects: .clickable"></a-entity>
        </a-entity>

        <a-assets>
            <a-asset-item id="jacobModel" src="public/jacob-typing.gltf"></a-asset-item>
            <a-asset-item id="headsetModel" src="public/headset-anim.gltf"></a-asset-item>
        </a-assets>


        <!-- Define the AR marker with 'kanji' preset -->
        <a-marker preset='kanji'>
            <!-- Add the Headset model -->
            <a-entity gltf-model="#headsetModel" foo position="0 0.2 0" scale="5 5 5" animation-mixer="loop:repeat" class="clickable" onclick="debouncedOnModelClick();"></a-entity>
            <!-- Adding myself -->
            <a-entity gltf-model="#jacobModel" foo position="0 0.2 0" scale="2 2 2" animation-mixer="loop:repeat"></a-entity>
        </a-marker>
    </a-scene>

    <script>
        function onModelClick()
        {
            alert('Model clicked');
        }

        function debounce(func, wait)
        {
            let timeout;

            return function executedFunction() {
                const context = this;
                const args = arguments;

                const later = function () {
                    timeout = null;
                    func.apply(context, args);
                };

                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedOnModelClick = debounce(onModelClick, 500);

        document.addEventListener('touchstart', enableRaycaster, { passive: true });
        document.addEventListener('mousemove', enableRaycaster, { passive: true });

        function enableRaycaster()
        {
            const raycasterCursor = document.getElementById('raycasterCursor');
            raycasterCursor.setAttribute('raycaster', 'objects', '.clickable');
        }
    </script>

</body>
</html>